#!/usr/bin/env zsh

# Get the path parameter
path="$1"

# Function to get terminal size
get_terminal_size() {
	local cols lines

	# Use FZF preview dimensions if available
	if [[ -n $FZF_PREVIEW_COLUMNS && -n $FZF_PREVIEW_LINES ]]; then
		cols=$FZF_PREVIEW_COLUMNS
		lines=$FZF_PREVIEW_LINES
	# Fallback to tput if available
	elif (( $+commands[tput] )); then
		cols=$(tput cols 2>/dev/null)
		lines=$(tput lines 2>/dev/null)
	# Fallback to COLUMNS/LINES environment variables
	elif [[ -n $COLUMNS && -n $LINES ]]; then
		cols=$COLUMNS
		lines=$LINES
	# Default fallback
	else
		cols=80
		lines=24
	fi

	echo "${cols}x${lines}"
}

# Function to preview a file
preview_file() {
	local file_path="$1"
	if (( $+commands[bat] )); then
		bat --style=numbers --color=always "$file_path"
	else
		cat "$file_path"
	fi
}

# Function to preview an image
preview_image() {
	local image_path="$1"
	if (( $+commands[chafa] )); then
		chafa --size "$(get_terminal_size)" "$image_path"
	else
		ls -l "$image_path"
	fi
}

# Check if the path is a directory
if [[ -d "$path" ]]; then
	# Use eza for directories, fallback to ls if eza is not installed
	if (( $+commands[eza] )); then
		eza -l --color=always "$path"
	else
		ls -l --color=always "$path"
	fi
elif [[ -f "$path" ]]; then
	# Check if the file command is available
	if (( $+commands[file] )); then
		# Check if the file is an image
		if file --mime-type "$path" | grep -q 'image/'; then
			preview_image "$path"
		else
			preview_file "$path"
		fi
	else
		# Default to bat if file command is not available
		preview_file "$path"
	fi
else
	echo "Invalid path"
fi
